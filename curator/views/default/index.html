{{# Pivot (in many places) based on whether the user is an editor (curator) or
# someone else looking at the study
viewOrEdit = (auth.user) and 'EDIT' or 'VIEW'

response.subtitle = "Building the tree, one study at a time"
}}

{{left_sidebar_enabled,right_sidebar_enabled=False,False}}
{{response.title = "Study Curator"}}
{{response.subtitle = "loading study list..."}}

{{### Add support scripts for single-page editor 

# JSON support for older browsers (esp. IE7) 
response.files.append(URL('static','js/json2.js'))

# Knockout.js for binding JSON model to editing UI 
response.files.append(URL('static','js/knockout-2.3.0.js'))

# KO plugin for paginated lists
response.files.append(URL('static','js/knockout-paged-e4a5770702.js'))

# Knockout bindings for Twitter Bootstrap components
response.files.append(URL('static','js/knockout-bootstrap.min.js'))

}}

{{extend 'layout.html'}}

<script type='text/javascript'>
    var viewOrEdit = '{{= viewOrEdit }}';
    var findAllStudies_url = "{{=findAllStudies_url}}";
</script>

<script src="{{=URL('static','js/curation-helpers.js')}}"></script>
<script src="{{=URL('static','js/curation-dashboard.js')}}"></script>

<div class="row">
    <div class="span12">
       {{if 'message' in globals():}}
        <h4>{{=message}}</h4>
       {{pass}}
        <div id="ajax-busy-bar" class="progress progress-striped active">
          <div class="bar" style="width: 100%;"></div>
        </div>
    </div>
</div><!-- /.row -->

<div class="row">
<div class="span8"><!-- not too wide... -->
{{if 'message' in globals():}}
<h4>{{=message}}X</h4>
{{pass}}

      <div class="navbar">
       <div class="navbar-inner">
        <form class="navbar-search pull-left">
            <input type="text" id="study-list-filter" class="search-query" style="widtH: 320px;"
                   placeholder="Filter by author, title, journal, year, DOI, tag, curator&hellip;"
                   data-bind="value: viewModel.listFilters.STUDIES.match, valueUpdate: 'afterkeydown'">
        </form>
        <ul class="nav" style="padding-left: 1em;">
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <span data-bind="text: viewModel.listFilters.STUDIES.workflow">WORKFLOW</span>
                  <b class="caret"></b>
                </a>
                <ul class="dropdown-menu" data-bind="foreach: ['Any workflow state', 'Draft study', 'Submitted for synthesis', 'Under revision', 'Included in synthetic tree']">
                    <li data-bind="css: {'disabled': viewModel.listFilters.STUDIES.workflow() == $data }">
                        <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.STUDIES.workflow($data); }">WORKFLOW</a>
                    </li>
                </ul>
            </li>
            <!--<li class="divider-vertical"></li>-->
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <span data-bind="text: viewModel.listFilters.STUDIES.order">SORT</span>
                  <b class="caret"></b>
                </a>
                <ul class="dropdown-menu" data-bind="foreach: ['Newest first', 'Oldest first'] "><!-- , 'Workflow state', 'Completeness'] -->
                    <li data-bind="css: {'disabled': viewModel.listFilters.STUDIES.order() == $data }">
                        <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.STUDIES.order($data); }">SORT</a>
                    </li>
                </ul>
            </li>
        </ul>
       </div>
      </div>

        <table class="table table-condensed">
          <thead>
            <tr>
              {{ if viewOrEdit == 'EDIT': }}
                <th>Reference (click to edit study)</th>
              {{ else: }}
                <th>Reference (click to view study)</th>
              {{ pass }}
                <th>Focal clade</th>
                <th>Curator</th>
                <!--
                <th style="text-align: right;">Publication</th>
                <th>Completeness</th>
                <th>Year</th>
                <th>Journal</th>
                <th>Actions</th>
                -->
            </tr>
          </thead>
          <tbody data-bind="foreach: { data: viewModel.filteredStudies().pagedItems(), as: 'study' }">
            <tr>
                <td data-bind="html: getViewOrEditLinks(study)">&nbsp;</td>
                <td data-bind="html: getFocalCladeLink(study)">&nbsp;</td>
                <td data-bind="html: getCuratorLink(study)">&nbsp;</td>
                <td data-bind="text: study.completeness">&nbsp;</td>
                <!--
                <td data-bind="text: study.is_deprecated">?</td>
                <td data-bind="text: study.pubYear">?</td>
                <td data-bind="html: getJournalLink(study)">?</td>
                <td data-bind="html: getSuggestedActions(study)">?</td>
                -->
            </tr>
            <tr>
                <td colspan="4" style="border-top: none; padding-top: 0px;">
                    <div class="full-study-ref" style="display: none; overflow: visible;">
                        <div Xclass=""
                             data-bind="html: study['ot:studyPublicationReference']">&nbsp;</div>
                        <div style="Xfont-size: 90%; margin-top: 3px;" data-bind="html: getPubLink(study)">&nbsp;</div>
                    </div>
                {{if False:}}
                    <!--<label class="pull-left">Tags:&nbsp;</label>-->
                    <!-- TODO: make all tags clickable (search in new window?) -->
                    <div class="bootstrap-tagsinput" 
                         style="display: inline-block; border: none; margin-bottom: 0; padding: 0 0 4px 0;"
                         data-bind="visible: study['ot:tag'] !== ''">
                    <!-- ko foreach: makeArray(study['ot:tag']) -->
                        <a class="tag label label-info" style="display: none;" 
                           href="#" data-bind="text: $data, visible: true"
                           onclick="filterByTag($(this).text()); return false;">&nbsp;</a>
                    <!-- /ko -->
                    </div>
                    <strong style="display: none;" data-bind="visible: study['ot:tag'] === ''">
                       <em>No tags</em>
                    </strong>

                    <!--<label class="pull-right">Publication:&nbsp;</label>-->
                {{pass}}
                </td>
            </tr>
          </tbody>
        </table>

        <div class="pagination pagination-centered pagination-small" 
             Xdata-bind="if: viewModel.filteredStudies()().length &gt; viewModel.filteredStudies().pagedItems().length">
          <ul>
            <li data-bind="css: { 'disabled': !viewModel.filteredStudies().prev.enabled() }" class="disabled">
                <a href="#" onclick="viewModel.filteredStudies().prev(); return false;">&laquo;</a>
            </li>
           <!-- ko foreach: getPageNumbers( viewModel.filteredStudies() ) -->
            <li data-bind="css: { 'active': (viewModel.filteredStudies().current() === $data) }" class="active">
                <a href="#" data-bind="text: $data" onclick="viewModel.filteredStudies().goToPage(parseInt($(this).text())); return false;">0</a>
            </li>
           <!-- /ko -->
            <li data-bind="css: { 'disabled': !viewModel.filteredStudies().next.enabled() }" class="disabled">
                <a href="#" onclick="viewModel.filteredStudies().next(); return false;">&raquo;</a>
            </li>
          </ul>
        </div>

    </div>
    <div class="span4">
        {{if 'message' in globals():}}
        <h4>{{=message}}X</h4>
        {{pass}}
      <div class="well well-large">
        <p>
        This tool allows you to contribute studies and trees to our database for
        synthesis. Once your data is submitted, you can return and make improvements,
        share your data more widely, and watch for changes in your area of interest.
        </p>
        <p>
        All data is stored as documents in <a href="https://github.com/" target="_blank">GitHub</a>, 
        a collaborative coding website. This curation tool makes it easy to edit and
        contribute data, but you'll need a (free) GitHub account to participate.
        </p>
        <p>
        Once you've created an account on GitHub, just <a href="/curator/user/login?_next=/curator">login</a> using the link above. Once
        you've agreed to give access to the OpenTree tool, you can start adding data
        immediately.
        </p>
      </div>
    </div><!-- /div.spanX -->
</div><!-- /.row -->

{{block right_sidebar}}
{{=A(T("Administrative Interface"), _href=URL('admin','default','index'), _class='btn',
     _style='margin-top: 1em;')}}
<h6>{{=T("Don't know what to do?")}}</h6>
<ul>
  <li>{{=A(T("Online examples"), _href=URL('examples','default','index'))}}</li>
  <li><a href="http://web2py.com">web2py.com</a></li>
  <li><a href="http://web2py.com/book">{{=T('Documentation')}}</a></li>
</ul>
{{end}}
